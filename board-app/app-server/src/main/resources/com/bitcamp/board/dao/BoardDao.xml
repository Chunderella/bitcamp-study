<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitcamp.board.dao.PartyDao">

    <resultMap type="party" id="partyMap">
    <id column="pno" property="no"/>
    <result column="meal" property="meal"/>
    <result column="title" property="title"/>
    <result column="cont" property="content"/>
    <result column="lit" property="limit"/>
    <result column="loc" property="location"/>
    <result column="addr" property="address"/>
    <result column="viewcnt" property="viewCnt"/>
    <result column="img" property="image"/>
    <result column="time" property="time"/>
    <result column="createdate" property="createDate"/>

    <association property="writer" javaType="member"> <!-- member객체는 party객체의 setter writer에 담아 -->
    <id column="mno" property="no"/>
    <result column="nick" property="nick"/>
    </association>
  
    <collection property="attachedFiles" ofType="attachedFile">
      <id column="pfno" property="no"/>
      <result column="path" property="filepath"/>
    </collection>
    
  </resultMap>
  
  <resultMap type="attachedFile" id="attachedFileMap">
    <id column="pfno" property="no"/>
    <result column="path" property="filepath"/>
    <result column="pno" property="partyNo"/>
  </resultMap>

  
  <select id="findAll" resultMap="partyMap">
    select
    p.pno,
    p.title,
    p.meal,
    p.lit,
    p.nick,
    p.age,
    p.gender,
    p.max,
    p.viewcnt,
    p.img,
    p.createdate
    from
    party p
    join member m on m.mno = p.mno
    order by
    pno desc
  </select>
  
  
    <select id="findByNo" resultMap="partyMap">
    select
      pno,
      title,
      cont,
      createddate,
      viewCnt,
      mno,
      nick,
      pfileno,
      path
    from 
      party p
      join member m on p.mno = m.mno
      left outer join party_file pf on p.pno=pf.pno
    where 
      p.pno=#{value}
  </select>
  
  <select id="findFilesByParty" resultMap="attachedFileMap">
    select 
      pfileno, 
      path, 
      pno 
    from 
     party_file
    where 
      pno = #{value}
  </select>

  <insert id="insert" parameterType="party"
          useGeneratedKeys="true" keyColumn="pno" keyProperty="no">
    insert into party(title,cont,mno) 
    values(#{title},#{content},#{writer.no})
  </insert>
  
  <update id="update" parameterType="party">
    update party set 
      title=#{title}, 
      cont=#{content} 
    where pno=#{no}
  </update>
  
  <delete id="delete">
    delete from party 
    where pno=#{value}
  </delete>

  <delete id="deleteByMember">
    delete from party 
    where mno=#{value}
  </delete>
  
  <insert id="insertFiles" parameterType="party">
    insert into party_file(path,pno) 
    values 
    <foreach collection="attachedFiles" item="file" separator=",">
      (#{file.path},#{no})
    </foreach>
  </insert>
  
  <delete id="deleteFiles">
    delete from party_file 
    where pno=#{value}
  </delete>
  
  <delete id="deleteFilesByMemberParties">
    delete from party_file 
    where pno in (select pno from party where mno = #{value})
  </delete>
  
  <delete id="deleteFile">
    delete from party_file 
    where pflieno=#{value}
  </delete>
  
  <select id="findFileByNo" resultMap="attachedFileMap">
    select 
      pflieno, 
      path, 
      pno 
    from 
      party_file 
    where 
      pflieno = #{value}
  </select>

</mapper>



